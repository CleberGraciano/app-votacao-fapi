<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>CRUD Participantes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .imagem-preview {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 6px;
    }
  </style>
</head>
<body class="p-4">

  <div class="container">
    <h2 class="mb-4">Cadastro de Participantes</h2>

    <form id="formParticipante">
      <input type="hidden" id="participanteId">

      <div class="row">
        <div class="col-md-6 mb-3">
          <label>Nome</label>
          <input type="text" class="form-control" id="nome" required>
        </div>
        <div class="col-md-3 mb-3">
          <label>Idade</label>
          <input type="number" class="form-control" id="idade" required>
        </div>
        <div class="col-md-3 mb-3">
          <label>Altura</label>
          <input type="text" class="form-control" id="altura" required>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4 mb-3">
          <label>Sexo</label>
          <select class="form-control" id="sexo" required>
            <option value="">Selecione</option>
            <option value="MASCULINO">Masculino</option>
            <option value="FEMININO">Feminino</option>
          </select>
        </div>
        <div class="col-md-4 mb-3">
          <label>Categoria</label>
          <select class="form-control" id="categoria" required></select>
        </div>
        <div class="col-md-4 mb-3">
          <label>Imagem</label>
          <input type="file" class="form-control" id="imagem" accept="image/*">
          <input type="hidden" id="imagemBase64">
          <img id="preview" class="preview d-none imagem-preview" />
        </div>
      </div>

      <button type="submit" class="btn btn-success">Salvar</button>
      <button type="button" class="btn btn-secondary" onclick="limparFormulario()">Limpar</button>
    </form>

    <hr>

    <h3>Lista de Participantes</h3>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Imagem</th>
          <th>Nome</th>
          <th>Idade</th>
          <th>Altura</th>
          <th>Sexo</th>
          <th>Categoria</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tabelaParticipantes"></tbody>
    </table>
  </div>

  <script>
    const API_PARTICIPANTES = "http://localhost:8080/api/participantes";
    const API_CATEGORIAS = "http://localhost:8080/api/categorias";

    document.addEventListener("DOMContentLoaded", () => {
      carregarCategorias();
      carregarParticipantes();

      document.getElementById("formParticipante").addEventListener("submit", salvarParticipante);
      document.getElementById("imagem").addEventListener("change", converterImagemParaBase64);
    });

    function carregarCategorias(callback) {
      fetch(API_CATEGORIAS)
        .then(res => res.json())
        .then(categorias => {
          const select = document.getElementById("categoria");
          select.innerHTML = '<option value="">Selecione</option>';
          categorias.forEach(cat => {
            const opt = document.createElement("option");
            opt.value = cat.id;
            opt.textContent = cat.nome;
            select.appendChild(opt);
          });
          if (callback) callback();
        });
    }

    function limparFormulario() {
      document.getElementById('formParticipante').reset();
      document.getElementById('idEditar').value = '';
      imagemBase64 = '';
      document.getElementById('preview').classList.add('d-none');
      document.getElementById('preview').src = '';
    }

    function carregarParticipantes() {
      fetch(API_PARTICIPANTES)
        .then(res => res.json())
        .then(participantes => {
          const tabela = document.getElementById("tabelaParticipantes");
          tabela.innerHTML = "";
          participantes.forEach(p => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td><img class="imagem-preview" src="data:image/jpeg;base64,${p.imagem || ''}" /></td>
              <td>${p.nome}</td>
              <td>${p.idade}</td>
              <td>${p.altura}</td>
              <td>${p.sexo}</td>
              <td>${p.categoria?.nome || ""}</td>
              <td>
                <button class="btn btn-primary btn-sm" onclick="editarParticipante(${p.id})">Editar</button>
                <button class="btn btn-danger btn-sm" onclick="deletarParticipante(${p.id})">Excluir</button>
              </td>
            `;
            tabela.appendChild(tr);
          });
        });
    }

    function salvarParticipante(event) {
      event.preventDefault();

      const participante = {
        nome: document.getElementById("nome").value,
        idade: parseInt(document.getElementById("idade").value),
        altura: document.getElementById("altura").value,
        sexo: document.getElementById("sexo").value,
        imagem: document.getElementById("imagemBase64").value,
        categoriaId: parseInt(document.getElementById("categoria").value)
      };

      const id = document.getElementById("participanteId").value;
      const url = id ? `${API_PARTICIPANTES}/${id}` : API_PARTICIPANTES;
      const metodo = id ? "PUT" : "POST";

      fetch(url, {
        method: metodo,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(participante)
      }).then(() => {
        document.getElementById("formParticipante").reset();
        document.getElementById("participanteId").value = "";
        carregarParticipantes();
      });
    }

    function editarParticipante(id) {
      fetch(`${API_PARTICIPANTES}/${id}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById("participanteId").value = data.id;
          document.getElementById("nome").value = data.nome;
          document.getElementById("idade").value = data.idade;
          document.getElementById("altura").value = data.altura;
          document.getElementById("sexo").value = data.sexo;
          document.getElementById("imagemBase64").value = data.imagem;

          imagemBase64 = data.imagem;

          const preview = document.getElementById('preview');
          preview.src = `data:image/jpeg;base64,${data.imagem}`;
          preview.classList.remove('d-none');

          carregarCategorias(() => {
            document.getElementById("categoria").value = data.categoria?.id || "";
          });
        });
    }

    function deletarParticipante(id) {
      if (confirm("Deseja realmente excluir este participante?")) {
        fetch(`${API_PARTICIPANTES}/${id}`, { method: "DELETE" })
          .then(() => carregarParticipantes());
      }
    }

    function converterImagemParaBase64(event) {
      const file = event.target.files[0];
      const reader = new FileReader();
      reader.onloadend = () => {
        document.getElementById("imagemBase64").value = reader.result.split(",")[1];
      };
      if (file) {
        reader.readAsDataURL(file);
      }
    }
  </script>
</body>
</html>
