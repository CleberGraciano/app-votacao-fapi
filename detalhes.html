<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>
  <title>Avaliação de Candidata</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8f8f8;
      font-family:"Montserrat", sans-serif;
    }

    .top-bar {
      background: linear-gradient(to right, #1b1464, #d4145a);
      color: white;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .categoria {
      text-align: center;
      color: #ff6600;
      font-weight: bold;
      margin: 1rem 0 0.5rem 0;
    }

    .candidata {
      text-align: center;
    }

    .candidata img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
    }

    .estrela {
      position: relative;
      display: inline-block;
    }

    .estrela-icon {
      position: absolute;
      bottom: 0;
      right: -10px;
      background-color: orange;
      color: white;
      border-radius: 50%;
      width: 25px;
      height: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .nome {
      font-weight: 500;
      margin-top: 0.5rem;
    }

    .avaliacoes {
      padding: 1rem;
      width: 80%;
      max-width: 300px;
      margin: 1rem auto;
      padding: 0.8rem;
    }

    .avaliacao {
      background: white;
      margin-bottom: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      
    }

    .avaliacao h4 {
      margin-bottom: 0.5rem;
    }

    .notas {
      display: flex;
      gap: 0.5rem;
      
    }

    .nota {
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 0.5rem 0.8rem;
      cursor: pointer;
      background-color: white;
      transition: background-color 0.2s ease, border 0.2s ease;
     
    }

    .nota.selecionada {
      background-color: #72b626;
      color: white;
      font-weight: bold;
      border: 2px solid #4a861a;
    }

    .enviar {
      display: block;
      width: 80%;
      max-width: 300px;
      margin: 1rem auto;
      padding: 0.8rem;
      text-align: center;
      background-color: #d4145a;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div>☰</div>
    <div style="background:white;color:black;padding:0.3rem 0.6rem;border-radius:50%;">NM</div>
  </div>

  <div class="categoria" id="categoria">
    <!-- Campos de avaliação inseridos via JS -->
  </div>

  <div class="candidata">
    <div class="estrela">
      <img src="https://via.placeholder.com/100" alt="Candidata">
      <div class="estrela-icon">★</div>
    </div>
    <div class="nome">Nome da Candidata</div>
  </div>

  <div class="avaliacoes" id="avaliacoes">
    <!-- Campos de avaliação inseridos via JS -->
  </div>

  <button class="enviar" id="enviarNotas" onclick="voltarPagina()" >ENVIAR NOTAS</button>

  <script>
    const tiposUrl = 'http://192.168.0.117:8080/api/tipos-avaliacao';
    const avaliacoesContainer = document.getElementById('avaliacoes');
    const botao  = document.getElementById('avaliacoes');


    const participanteId = getIdFromURL();
    const participanteUrl = `http://192.168.0.117:8080/api/participantes/${participanteId}`;

    const notasDisponiveis = [5, 6, 7, 8, 9, 10];
    const notasSelecionadas = {};
  
    

    const nomeCategoria = document.getElementById("categoria");

    // Função para pegar parâmetros da URL
    function getIdFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get('id');
    }

    function getCategoriaFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get('categoria');
    }
    

    const nomeCat = getCategoriaFromURL();

    const textoCat = document.createElement("div");
    textoCat.className = "text-uppercase fw-bold text-warning mb-0";
    textoCat.textContent = `CATEGORIA ${nomeCat}`;
    nomeCategoria.appendChild(textoCat);

    fetch(participanteUrl)
    .then(res => res.json())
    .then(data => {
      const nomeDiv = document.querySelector('.nome');
      const imagemEl = document.querySelector('.candidata img');

      nomeDiv.textContent = data.nome;
      if (data.imagem) {
        imagemEl.src = `data:image/jpeg;base64,${data.imagem}`;
      } else {
        imagemEl.src = 'https://via.placeholder.com/100'; // imagem padrão

       
      }
    })
    .catch(err => {
      console.error('Erro ao buscar participante:', err);
    });


  

    function voltarPagina(){
        sessionStorage.setItem('recarregarAoVoltar', 'true');
    window.history.back();
  
    }

    async function enviarPontuacao(participanteId, notasSelecionadas) {
        console.log(notasSelecionadas);
        const url = `http://192.168.0.117:8080/api/participantes/${participanteId}/pontuacoes`;

        const payload = Object.entries(notasSelecionadas).map(([tipoAvaliacaoId, valor]) => ({
                tipoAvaliacaoId,
                valor
            }));

            console.log(JSON.stringify(payload));

        return fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        }   

    

    function criarBlocoAvaliacao(tipo) {
      const div = document.createElement('div');
      div.className = 'avaliacao';
      div.innerHTML = `<h4>${tipo.nome}</h4>`;
      
      const notasDiv = document.createElement('div');
      notasDiv.className = 'notas';

      notasDisponiveis.forEach(nota => {
        const btn = document.createElement('div');
        btn.className = 'nota';
        btn.textContent = nota;
        btn.onclick = () => {
          notasSelecionadas[tipo.id] = nota;
            //  enviarPontuacao(participanteId, tipo.id, nota);
          // Remove seleção anterior
          [...notasDiv.children].forEach(n => n.classList.remove('selecionada'));
          
          btn.classList.add('selecionada');
         
        };
        notasDiv.appendChild(btn);
      });

      div.appendChild(notasDiv);
      avaliacoesContainer.appendChild(div);
    }
    let qtdAvaliacoes = 0;
    fetch(tiposUrl)
      .then(res => res.json())
      .then(data => {
        qtdAvaliacoes = data.length;
        console.log(qtdAvaliacoes)
        data.forEach(tipo => criarBlocoAvaliacao(tipo));
      })
      .catch(err => {
        console.error('Erro ao buscar tipos de avaliação:', err);
      });
    


    document.querySelector('.enviar').onclick = () => {
        
        
        // alert('ID'+valor);
        // if (Object.keys(notasSelecionadas).length === tiposUrl) {
        //     console.log('Notas selecionadas:', notasSelecionadas);
            // for (const [tipo, nota] of Object.entries(notasSelecionadas)) {
            //     console.log(tipo, nota, participanteId)
            //      enviarPontuacao(participanteId, notasSelecionadas);
            //  }
        //     alert('Notas enviadas! (ver console)');
        // } else {
        //     alert('Favor selecione todas avaliações.');

        // }

        if (Object.keys(notasSelecionadas).length === qtdAvaliacoes) {
            enviarPontuacao(participanteId, notasSelecionadas);
            voltarPagina();
        } else {
            alert('Favor selecione todas avaliações.');

         }
        
    };
  </script>
</body>
</html>
